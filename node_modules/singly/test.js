var Singly = require('./lib');
var express = require('express');

var clientID = process.argv[2];
var clientSecret = process.argv[3];

var singly = new Singly(clientID, clientSecret, 'http://localhost:8044/callback');

var app = express.createServer();

var accessToken;

app.get('/', function(req, res) {
  res.redirect(singly.getAuthorizeURL('facebook'));
});

app.get('/callback', function(req, res) {
  singly.getAccessToken(req.param('code'), function(err, resp, auth) {
    accessToken = auth.access_token;
    res.redirect('/all');
  });
});

app.get('/all', function(req, res) {
  if (!accessToken) return res.redirect('/');
  singly.get('/types/all', {access_token:accessToken}, function(err, resp, body) {
    if(err) return res.send(err, 500);
    res.send(body);
  });
});

app.post('/status', function(req, res) {
  if (!accessToken) return res.send('must auth at http://localhost:8044/', 401);
  var qs = req.query;
  qs.access_token = accessToken;
  singly.post('/types/statuses', {qs:qs}, function(err, resp, body) {
   if (err) return res.send(err, 500);
   res.send(body);
  });
});

app.post('/link', function(req, res) {
  if (!accessToken) return res.send('must auth at http://localhost:8044/', 401);
  var qs = req.query;
  qs.access_token = accessToken;
  singly.post('/types/links', {qs:qs}, function(err, resp, body) {
   if (err) return res.send(err, 500);
   res.send(body);
  });
});


app.listen(8044);
console.log('open http://localhost:8044');
